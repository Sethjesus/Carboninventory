<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸŒ¿ ESG ç°¡æ˜“ç¢³ç›¤æŸ¥ v5.4 Finalï¼ˆGit ç‰ˆï¼‰</title>

  <!-- PWA -->
  <meta name="theme-color" content="#16a34a" />
  <link rel="manifest" href="manifest.json" />

  <!-- å¥—ä»¶ï¼ˆCDNï¼‰ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <style>
    :root{ --brand:#16a34a; --ink:#0f172a; --bg:#f8fafc; --bg-dark:#0f172a; }
    html,body{margin:0;padding:0;font-family:"Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--ink);transition:background .3s,color .3s}
    .dark body{background:var(--bg-dark);color:#f8fafc}
    .card{background:#fff;border-radius:1rem;box-shadow:0 10px 28px rgba(2,6,23,.08);padding:1.2rem}
    .dark .card{background:#1e293b}
    .btn{background:var(--brand);color:#fff;border-radius:.6rem;padding:.5rem 1rem;font-weight:700}
    .btn-ghost{border:1px dashed #94a3b8;color:#334155;border-radius:.6rem;padding:.5rem 1rem;font-weight:700;background:transparent}
    .dark .btn-ghost{color:#f1f5f9;border-color:#64748b}
    .badge{padding:.2rem .6rem;border-radius:999px;font-weight:700;font-size:.8rem}
    .b1{background:#fee2e2;color:#991b1b}.b2{background:#dbeafe;color:#1e40af}.b3{background:#d1fae5;color:#065f46}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.4rem .6rem;border-bottom:1px solid #e2e8f0;text-align:left}
    input,select{border:1px solid #e2e8f0;border-radius:.5rem;padding:.3rem .5rem;width:100%}
    .dark input,.dark select{background:#334155;border-color:#475569;color:#f8fafc}
    .num{text-align:right}
    .month-btn{padding:.4rem .8rem;border-radius:.6rem;font-weight:700;cursor:pointer}
    .month-active{background:var(--brand);color:#fff}
    #toast{position:fixed;right:20px;bottom:30px;background:var(--brand);color:#fff;padding:.5rem .9rem;border-radius:.7rem;font-weight:700;opacity:0;transform:translateY(14px);transition:.4s;z-index:50}
    #toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>

<body>
<header class="max-w-7xl mx-auto px-4 py-5 flex items-center justify-between">
  <h1 class="text-2xl font-extrabold flex items-center gap-2">
    ğŸŒ¿ ESG ç°¡æ˜“ç¢³ç›¤æŸ¥ v5.4
    <span class="badge b1">S1</span><span class="badge b2">S2</span><span class="badge b3">S3</span>
  </h1>
  <button id="themeToggle" class="btn-ghost text-sm">ğŸŒ / ğŸŒ™</button>
</header>
<div id="toast">å·²è‡ªå‹•å„²å­˜ï¼</div>

<main class="max-w-7xl mx-auto px-4 pb-28 space-y-6">

  <!-- ä¼æ¥­è³‡è¨Š -->
  <section class="card">
    <h2 class="font-bold text-lg mb-3">ğŸ¢ ä¼æ¥­è³‡è¨Š</h2>
    <div class="grid md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm mb-1">å…¬å¸åç¨±</label>
        <input id="companyName" type="text" value="æ™¯æ²› ESG" placeholder="è«‹è¼¸å…¥å…¬å¸åç¨±">
      </div>
      <div>
        <label class="block text-sm mb-1">å¹´åº¦ï¼ˆè¥¿å…ƒå¹´ï¼‰</label>
        <input id="fiscalYear" type="number" value="2025" min="2000" max="2100" step="1">
      </div>
      <div class="flex items-end gap-2 flex-wrap">
        <button id="saveMeta" class="btn">å„²å­˜å…¬å¸/å¹´åº¦</button>
        <button id="btnLoadGit" class="btn-ghost">å¾ Git è¼‰å…¥</button>
        <button id="btnSaveGit" class="btn">å­˜åˆ° Git</button>
        <span id="metaSaved" class="text-sm text-slate-500"></span>
      </div>
    </div>
  </section>

  <!-- æœˆä»½ -->
  <section class="card">
    <h2 class="font-bold text-lg mb-3">ğŸ“… æœˆä»½é¸æ“‡</h2>
    <div id="monthTabs" class="flex flex-wrap gap-2"></div>
  </section>

  <!-- ä¸»è¡¨æ ¼ -->
  <section class="card">
    <div class="flex justify-between items-center mb-3">
      <h2 class="font-bold text-lg">ğŸ“‹ æ´»å‹•æ•¸æ“šè¼¸å…¥</h2>
      <div class="flex gap-2">
        <button id="btnAdd" class="btn-ghost">+ æ–°å¢åˆ—</button>
        <button id="btnPreset" class="btn">è¼‰å…¥é è¨­ 10 é …</button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="table" class="text-sm">
        <thead class="bg-slate-100 dark:bg-slate-700">
          <tr>
            <th>é …ç›®</th><th>åˆ†é¡</th><th>ç¯„ç–‡</th>
            <th class="num">ç”¨é‡</th><th>å–®ä½</th>
            <th class="num">æ’æ”¾ä¿‚æ•¸</th><th>éƒ¨é–€ï¼æ“šé»</th>
            <th class="num">æ’æ”¾é‡ (kgCOâ‚‚e)</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot class="bg-slate-50 dark:bg-slate-800 font-bold">
          <tr>
            <td>åˆè¨ˆ</td><td></td><td></td>
            <td id="sumAct" class="num">â€”</td><td></td><td></td><td></td>
            <td id="sumTotal" class="num">0</td><td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- åŒ¯å‡º / åŒ¯å…¥ -->
    <div class="mt-4 flex flex-wrap gap-3">
      <button id="btnCalc" class="btn">é‡æ–°è¨ˆç®—</button>
      <button id="btnExportXlsxMonth" class="btn-ghost">åŒ¯å‡ºæœ¬æœˆ Excelï¼ˆ.xlsxï¼‰</button>
      <button id="btnExportXlsxYear"  class="btn-ghost">åŒ¯å‡ºå…¨å¹´ Excelï¼ˆå¤šå·¥ä½œè¡¨ï¼‰</button>
      <label class="btn-ghost cursor-pointer">åŒ¯å…¥ Excel
        <input id="fileImportXlsx" type="file" class="hidden" accept=".xlsx,.xls">
      </label>
    </div>
  </section>

  <!-- åœ–è¡¨ -->
  <section class="card">
    <div class="grid md:grid-cols-3 gap-6">
      <div><h3 class="font-bold mb-2">å„é …ç›®æ’æ”¾é‡ï¼ˆkgCOâ‚‚eï¼‰</h3><canvas id="chartItems"></canvas></div>
      <div><h3 class="font-bold mb-2">S1/S2/S3 çµ„æˆæ¯”ä¾‹</h3><canvas id="chartScopes"></canvas></div>
      <div><h3 class="font-bold mb-2">éƒ¨é–€ï¼æ“šé»å½™ç¸½</h3><canvas id="chartDept"></canvas></div>
    </div>
  </section>

  <!-- PDF -->
  <section class="card">
    <div class="flex flex-wrap gap-3 items-center">
      <label class="font-semibold">ğŸ“„ é¸æ“‡å¹´ä»½ï¼š</label>
      <select id="pdfYear" class="border rounded-md px-2 py-1">
        <option>2024</option><option selected>2025</option><option>2026</option>
      </select>
      <button id="exportPDF" class="btn">åŒ¯å‡ºå¹´åº¦å ±è¡¨ PDF</button>
    </div>
  </section>

  <!-- datalistï¼šæ–°å¢è‡ªé¸é …ç›®ç”¨ -->
  <datalist id="itemList"></datalist>

  <!-- JS ä¸»ç¨‹å¼ -->
  <script>
    // ===== å…¨åŸŸç‹€æ…‹ =====
    const tbody = document.getElementById('tbody');
    const sumAct = document.getElementById('sumAct');
    const sumTotal = document.getElementById('sumTotal');
    const toast = document.getElementById('toast');
    const themeToggle = document.getElementById('themeToggle');
    const LS_THEME = 'carbonTheme';
    const META_KEY = 'carbonMeta';
    let currentMonth = new Date().getMonth() + 1;
    let store = JSON.parse(localStorage.getItem('carbonStore') || '{}');
    let charts = {};

    // ===== ä¼æ¥­è³‡è¨Šï¼ˆå…¬å¸/å¹´åº¦ï¼‰ =====
    const companyNameEl = document.getElementById('companyName');
    const fiscalYearEl  = document.getElementById('fiscalYear');
    const metaSavedEl   = document.getElementById('metaSaved');
    function loadMeta(){
      const meta = JSON.parse(localStorage.getItem(META_KEY) || '{}');
      if(meta.company) companyNameEl.value = meta.company;
      if(meta.year)    fiscalYearEl.value  = meta.year;
    }
    function saveMeta(){
      const meta = {
        company: (companyNameEl.value||'').trim() || 'å…¬å¸åç¨±',
        year: parseInt(fiscalYearEl.value) || new Date().getFullYear()
      };
      localStorage.setItem(META_KEY, JSON.stringify(meta));
      metaSavedEl.textContent = 'å·²å„²å­˜';
      setTimeout(()=>metaSavedEl.textContent='', 1500);
    }
    document.getElementById('saveMeta').onclick = saveMeta;
    loadMeta();

    // ===== å›ºå®šç¯„ç–‡èˆ‡é è¨­åˆ— =====
    const SCOPE_FIX = {
      'é›»åŠ›':2, 'æ°´':2, 'äº¤é€š':3, 'è»Šç”¨æ±½æ²¹':1,
      'æŸ´æ²¹':1, 'å¤©ç„¶æ°£':1, 'åœ˜é«”è†³é£Ÿ':3, 'æ´—æ½”ç²¾':3, 'è¡›ç”Ÿç´™':3, 'å»¢(æ±¡)æ°´è™•ç†':3
    };
    const PRESET = [
      {name:'é›»åŠ›', category:'èƒ½æº', scope:2, unit:'kWh', factor:0.495, dept:'ç¸½éƒ¨'},
      {name:'æ°´', category:'è³‡æº', scope:2, unit:'mÂ³', factor:0.156, dept:'ç¸½éƒ¨'},
      {name:'äº¤é€š', category:'é€šå‹¤', scope:3, unit:'km', factor:0.251, dept:'æ¥­å‹™éƒ¨'},
      {name:'è»Šç”¨æ±½æ²¹', category:'ç‡ƒæ–™', scope:1, unit:'L', factor:2.92, dept:'ç‰©æµ'},
      {name:'æŸ´æ²¹', category:'ç‡ƒæ–™', scope:1, unit:'L', factor:3.32, dept:'ç‰©æµ'},
      {name:'å¤©ç„¶æ°£', category:'ç‡ƒæ–™', scope:1, unit:'mÂ³', factor:2.63, dept:'é¤é£²éƒ¨'},
      {name:'åœ˜é«”è†³é£Ÿ', category:'é¤é£²', scope:3, unit:'ä»½', factor:1.29, dept:'é¤é£²éƒ¨'},
      {name:'æ´—æ½”ç²¾', category:'ç”¨å“', scope:3, unit:'kg', factor:1.32, dept:'æ¸…æ½”'},
      {name:'è¡›ç”Ÿç´™', category:'ç”¨å“', scope:3, unit:'kg', factor:0.402, dept:'è¡Œæ”¿'},
      {name:'å»¢(æ±¡)æ°´è™•ç†', category:'å»¢æ£„ç‰©', scope:3, unit:'mÂ³', factor:0.533, dept:'æ¸…æ½”'}
    ];

    // ===== æœˆä»½åˆ†é  =====
    function buildMonthTabs(){
      const wrap = document.getElementById('monthTabs');
      wrap.innerHTML = '';
      for(let m=1;m<=12;m++){
        const b = document.createElement('button');
        b.textContent = m+'æœˆ';
        b.className = 'month-btn ' + (m===currentMonth?'month-active':'');
        b.onclick = () => { save(); currentMonth = m; if(!store[m]) store[m]=[]; renderRows(); calc(); buildMonthTabs(); };
        wrap.appendChild(b);
      }
    }

    // ===== åˆ—ç”Ÿæˆ =====
    function trPresetRow(o){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${o.name}</td>
        <td>${o.category}</td>
        <td>S${o.scope}</td>
        <td><input type="number" value="${o.activity||0}" class="num activity"></td>
        <td>${o.unit}</td>
        <td>${o.factor}</td>
        <td><input type="text" value="${o.dept||'ç¸½éƒ¨'}"></td>
        <td class="num emi">0</td>
        <td><button class="text-red-500 del">åˆª</button></td>`;
      return tr;
    }
    function trCustomRow(o){
      const s = parseInt(o.scope||3);
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input list="itemList" type="text" value="${o.name||''}" placeholder="è¼¸å…¥æˆ–é¸æ“‡é …ç›®"></td>
        <td><input type="text" value="${o.category||''}"></td>
        <td>
          <select>
            <option value="1" ${s===1?'selected':''}>S1</option>
            <option value="2" ${s===2?'selected':''}>S2</option>
            <option value="3" ${s===3?'selected':''}>S3</option>
          </select>
        </td>
        <td><input type="number" value="${o.activity||0}" class="num activity"></td>
        <td><input type="text" value="${o.unit||''}"></td>
        <td><input type="number" value="${o.factor||0}" step="0.001"></td>
        <td><input type="text" value="${o.dept||'ç¸½éƒ¨'}"></td>
        <td class="num emi">0</td>
        <td><button class="text-red-500 del">åˆª</button></td>`;
      return tr;
    }

    // ===== æ–°å¢/é è¨­ =====
    document.getElementById('btnAdd').onclick = () => tbody.appendChild(trCustomRow({scope:3}));
    document.getElementById('btnPreset').onclick = () => {
      tbody.innerHTML=''; PRESET.forEach(p=>tbody.appendChild(trPresetRow({...p,activity:0}))); save(); calc();
    };

    // ===== å„²å­˜/è¼‰å…¥ï¼ˆæœ¬æ©Ÿï¼‰ =====
    function gatherRows(){
      return [...tbody.querySelectorAll('tr')].map(tr=>{
        const t=tr.children;
        const name=t[0].querySelector('input')?t[0].querySelector('input').value:t[0].textContent;
        const category=t[1].querySelector('input')?t[1].querySelector('input').value:t[1].textContent;
        const scopeStr=t[2].querySelector('select')?t[2].querySelector('select').value:t[2].textContent.replace('S','');
        const scope=parseInt(scopeStr)||3;
        const activity=parseFloat(t[3].querySelector('input').value)||0;
        const unit=t[4].querySelector('input')?t[4].querySelector('input').value:t[4].textContent;
        const factor=parseFloat(t[5].querySelector('input')?t[5].querySelector('input').value:t[5].textContent)||0;
        const dept=t[6].querySelector('input').value||'';
        return {name,category,scope,activity,unit,factor,dept};
      });
    }
    function save(){
      store[currentMonth] = gatherRows();
      localStorage.setItem('carbonStore', JSON.stringify(store));
      toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1200);
    }
    function renderRows(){
      tbody.innerHTML='';
      (store[currentMonth]||[]).forEach(r=>{
        if(SCOPE_FIX[r.name]) tbody.appendChild(trPresetRow(r));
        else tbody.appendChild(trCustomRow(r));
      });
    }

    // ===== è¨ˆç®—èˆ‡åœ–è¡¨ï¼ˆä»¥ç›®å‰æœˆä»½ç‚ºä¸»ï¼‰ =====
    function calc(){
      let total=0, actSum=0;
      [...tbody.querySelectorAll('tr')].forEach(tr=>{
        const act=parseFloat(tr.querySelector('.activity')?.value)||0;
        const factor=parseFloat(tr.children[5].textContent || tr.children[5].querySelector('input')?.value)||0;
        const emi=act*factor;
        tr.querySelector('.emi').textContent = emi.toFixed(3);
        total+=emi; actSum+=act;
      });
      sumTotal.textContent = total.toFixed(3);
      sumAct.textContent   = actSum.toFixed(2);
      save(); updateCharts();
    }
    document.getElementById('btnCalc').onclick = calc;
    tbody.addEventListener('input', calc);
    tbody.addEventListener('click', e=>{ if(e.target.classList.contains('del')){ e.target.closest('tr').remove(); calc(); } });

    function updateCharts(){
      const rows=store[currentMonth]||[];
      const labels=rows.map(r=>r.name);
      const emis=rows.map(r=>(r.activity*r.factor));
      const byScope={S1:0,S2:0,S3:0}, byDept={};
      rows.forEach(r=>{
        const s='S'+(r.scope||3);
        const emi=(r.activity||0)*(r.factor||0);
        byScope[s]+=emi;
        byDept[r.dept]=(byDept[r.dept]||0)+emi;
      });

      charts.items?.destroy(); charts.scopes?.destroy(); charts.dept?.destroy();
      charts.items=new Chart(document.getElementById('chartItems'),{
        type:'bar', data:{labels,datasets:[{label:'æ’æ”¾é‡',data:emis}]},
        options:{responsive:true,plugins:{legend:{display:false}}}
      });
      charts.scopes=new Chart(document.getElementById('chartScopes'),{
        type:'pie', data:{labels:Object.keys(byScope),datasets:[{data:Object.values(byScope)}]}
      });
      charts.dept=new Chart(document.getElementById('chartDept'),{
        type:'bar', data:{labels:Object.keys(byDept),datasets:[{label:'éƒ¨é–€',data:Object.values(byDept)}]},
        options:{indexAxis:'y',plugins:{legend:{display:false}}}
      });
    }

    // ===== Excelï¼ˆ.xlsxï¼‰ =====
    function rowsToSheet(rows, meta){
      const company=(meta?.company || companyNameEl.value || 'å…¬å¸åç¨±').trim();
      const year=meta?.year || parseInt(fiscalYearEl.value) || new Date().getFullYear();
      const header=['é …ç›®','åˆ†é¡','ç¯„ç–‡(S1/S2/S3)','ç”¨é‡','å–®ä½','æ’æ”¾ä¿‚æ•¸','éƒ¨é–€','æ’æ”¾é‡(kgCO2e)'];
      const data=[['å…¬å¸åç¨±',company],['å¹´åº¦',String(year)],[],header];
      rows.forEach(r=>{
        data.push([r.name,r.category,'S'+(r.scope||3),r.activity||0,r.unit||'',r.factor||0,r.dept||'',((r.activity||0)*(r.factor||0)).toFixed(3)]);
      });
      const ws=XLSX.utils.aoa_to_sheet(data);
      ws['!cols']=[{wch:16},{wch:22},{wch:14},{wch:12},{wch:10},{wch:16},{wch:16},{wch:18}];
      ws['!freeze']={xSplit:0,ySplit:4};
      return ws;
    }
    function getMonthRows(m){ return (store[m]||[]); }

    document.getElementById('btnExportXlsxMonth').onclick=()=>{
      calc();
      const meta=JSON.parse(localStorage.getItem(META_KEY)||'{}');
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, rowsToSheet(getMonthRows(currentMonth),meta), `${currentMonth}æœˆ`);
      const company=(meta.company||companyNameEl.value||'å…¬å¸').replace(/[\\\/:*?"<>|]/g,'_');
      const year=meta.year||parseInt(fiscalYearEl.value)||new Date().getFullYear();
      XLSX.writeFile(wb, `${company}_ç¢³ç›¤æŸ¥_${year}_${currentMonth}æœˆ.xlsx`);
    };

    document.getElementById('btnExportXlsxYear').onclick=()=>{
      calc();
      const meta=JSON.parse(localStorage.getItem(META_KEY)||'{}');
      const wb=XLSX.utils.book_new();
      for(let m=1;m<=12;m++){
        XLSX.utils.book_append_sheet(wb, rowsToSheet(getMonthRows(m),meta), `${m}æœˆ`);
      }
      const company=(meta.company||companyNameEl.value||'å…¬å¸åç¨±').replace(/[\\\/:*?"<>|]/g,'_');
      const year=meta.year||parseInt(fiscalYearEl.value)||new Date().getFullYear();

      // å¹´åº¦å½™ç¸½
      const byScope={S1:0,S2:0,S3:0}, byDept={};
      for(let m=1;m<=12;m++){
        (store[m]||[]).forEach(r=>{
          const s='S'+(parseInt(r.scope)||3);
          const emi=(parseFloat(r.activity)||0)*(parseFloat(r.factor)||0);
          byScope[s]+=emi; const d=r.dept||'ç¸½éƒ¨'; byDept[d]=(byDept[d]||0)+emi;
        });
      }
      const summary=[['å…¬å¸åç¨±', (meta.company||companyNameEl.value||'å…¬å¸åç¨±')], ['å¹´åº¦', String(year)], [], ['å¹´åº¦å½™ç¸½','kgCO2e'],
                     ['S1',byScope.S1],['S2',byScope.S2],['S3',byScope.S3],[],['éƒ¨é–€','kgCO2e']];
      Object.keys(byDept).forEach(k=>summary.push([k,byDept[k]]));
      const wsSum=XLSX.utils.aoa_to_sheet(summary); wsSum['!cols']=[{wch:16},{wch:22}];
      XLSX.utils.book_append_sheet(wb, wsSum, 'å¹´åº¦å½™ç¸½');

      XLSX.writeFile(wb, `${company}_ç¢³ç›¤æŸ¥_${year}_å…¨å¹´.xlsx`);
    };

    // ===== PDF åŒ¯å‡ºï¼ˆä»¥ç›®å‰æœˆä»½åœ–è¡¨ç”¢å‡ºï¼Œæ¨™é¡Œå«å…¬å¸ï¼‹å¹´æœˆï¼‰ =====
    function rafWait(frames=2){ return new Promise(res=>{ const step=n=>{ if(n<=0) return res(); requestAnimationFrame(()=>step(n-1)); }; step(frames); }); }
    document.getElementById('exportPDF').onclick = async ()=>{
      try{
        calc(); updateCharts(); await rafWait(2);
        if(!window.PDFLib) throw new Error('pdf-lib æœªè¼‰å…¥');
        const meta=JSON.parse(localStorage.getItem(META_KEY)||'{}');
        const company=(meta.company||companyNameEl.value||'å…¬å¸åç¨±').trim();
        const year=meta.year||parseInt(fiscalYearEl.value)||new Date().getFullYear();
        const month=currentMonth;

        const c1=document.getElementById('chartItems');
        const c2=document.getElementById('chartScopes');
        const c3=document.getElementById('chartDept');
        const img1=c1.toDataURL('image/png',1.0);
        const img2=c2.toDataURL('image/png',1.0);
        const img3=c3.toDataURL('image/png',1.0);

        const {PDFDocument,StandardFonts,rgb}=PDFLib;
        const pdf=await PDFDocument.create();
        const page=pdf.addPage([842,595]); // A4 æ©«å¼
        const font=await pdf.embedFont(StandardFonts.Helvetica);
        page.setFont(font); page.setFontSize(18);
        page.drawText(`${company}ï½œç¢³ç›¤æŸ¥æœˆå ±ï¼ˆ${year} å¹´ ${month} æœˆï¼‰`,{x:40,y:560,color:rgb(0,0.4,0.2)});
        page.setFontSize(12);
        page.drawText(`ç¸½æ’æ”¾é‡ï¼ˆ${month}æœˆï¼‰ï¼š${sumTotal.textContent} kgCOâ‚‚e`,{x:40,y:535});

        const p1=await pdf.embedPng(img1), p2=await pdf.embedPng(img2), p3=await pdf.embedPng(img3);
        page.drawImage(p1,{x:40,y:300,width:360,height:200});
        page.drawImage(p2,{x:430,y:300,width:360,height:200});
        page.drawImage(p3,{x:40,y:70,width:750,height:200});

        const bytes=await pdf.save();
        const a=document.createElement('a');
        a.href=URL.createObjectURL(new Blob([bytes],{type:'application/pdf'}));
        const safeCompany=company.replace(/[\\\/:*?"<>|]/g,'_');
        a.download=`${safeCompany}_ESG_Report_${year}_M${month}.pdf`;
        a.click();
      }catch(err){ alert('PDF åŒ¯å‡ºå¤±æ•—ï¼š'+err.message); }
    };

    // ===== Git è®€å¯«ï¼ˆNetlify Functionsï¼‰ =====
    function slugifyCompany(name){
      return (name||'').trim().replace(/[\\\/:*?"<>|.\s]+/g,'_').toLowerCase();
    }
    function getCurrentMeta(){
      const meta = JSON.parse(localStorage.getItem(META_KEY)||'{}');
      return {
        company: (meta.company || companyNameEl.value || 'å…¬å¸åç¨±').trim(),
        year: meta.year || parseInt(fiscalYearEl.value) || new Date().getFullYear()
      };
    }

    async function loadFromGit(){
      const { company, year } = getCurrentMeta();
      const slug = slugifyCompany(company);
      const url = `https://raw.githubusercontent.com/Sethjesus/Carboninventory/main/data/${slug}_${year}.json`;
      try{
        const res = await fetch(url, { cache: 'no-store' });
        if(!res.ok){ alert('æ‰¾ä¸åˆ°é›²ç«¯è³‡æ–™ï¼Œä»ä½¿ç”¨æœ¬æ©Ÿè³‡æ–™'); return; }
        const json = await res.json();
        store = json.months || {};
        // ä¸‹æ‹‰å€™é¸
        const dl = document.getElementById('itemList');
        const names = new Set();
        Object.values(store).flat().forEach(r=>{ if(r?.name) names.add(r.name) });
        ['é›»åŠ›','æ°´','äº¤é€š','è»Šç”¨æ±½æ²¹','æŸ´æ²¹','å¤©ç„¶æ°£','åœ˜é«”è†³é£Ÿ','æ´—æ½”ç²¾','è¡›ç”Ÿç´™','å»¢(æ±¡)æ°´è™•ç†'].forEach(n=>names.add(n));
        dl.innerHTML = [...names].map(n=>`<option value="${n}"></option>`).join('');
        if(!store[currentMonth]) currentMonth = new Date().getMonth()+1;
        renderRows(); calc(); updateCharts();
        toastIt('å·²å¾ Git è¼‰å…¥');
      }catch(e){
        alert('è¼‰å…¥å¤±æ•—ï¼š'+e.message);
      }
    }

    async function saveToGit(){
      const { company, year } = getCurrentMeta();
      save(); // å…ˆæŠŠç›®å‰æœˆå›å­˜åˆ° store
      try{
        const resp = await fetch('/.netlify/functions/save', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ company, year, months: store })
        });
        const r = await resp.json();
        if(!resp.ok) throw new Error(r.error || resp.statusText);
        toastIt('å·²å­˜åˆ° Git âœ…');
      }catch(e){
        alert('å­˜åˆ° Git å¤±æ•—ï¼š'+e.message);
      }
    }

    function toastIt(msg){
      const prev = toast.textContent;
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>{ toast.classList.remove('show'); toast.textContent=prev; }, 1500);
    }

    document.getElementById('btnLoadGit').onclick = loadFromGit;
    document.getElementById('btnSaveGit').onclick = saveToGit;

    // ===== ä¸»é¡Œ & åˆå§‹åŒ– =====
    function applyTheme(t){ document.documentElement.classList.toggle('dark', t==='dark'); localStorage.setItem(LS_THEME,t); }
    themeToggle.onclick = ()=>{ const isDark=document.documentElement.classList.contains('dark'); applyTheme(isDark?'light':'dark'); };
    applyTheme(localStorage.getItem(LS_THEME)||'light');

    function init(){
      buildMonthTabs();
      // é è¨­ä¸‹æ‹‰ï¼ˆå…ˆæ”¾é è¨­10é …ï¼‰
      document.getElementById('itemList').innerHTML = PRESET.map(p=>`<option value="${p.name}"></option>`).join('');
      if(!store[currentMonth]) store[currentMonth]=[];
      if(store[currentMonth].length===0){ tbody.innerHTML=''; PRESET.forEach(p=>tbody.appendChild(trPresetRow({...p,activity:0}))); save(); }
      renderRows(); calc();
      if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
    }
    init();
  </script>
</main>
</body>
</html>
