<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🌿 ESG 簡易碳盤查 v5.4 Final</title>

  <!-- PWA -->
  <meta name="theme-color" content="#16a34a" />
  <link rel="manifest" href="manifest.json" />

  <!-- 套件（CDN） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <style>
    :root{ --brand:#16a34a; --ink:#0f172a; --bg:#f8fafc; --bg-dark:#0f172a; }
    html,body{margin:0;padding:0;font-family:"Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--ink);transition:background .3s,color .3s}
    .dark body{background:var(--bg-dark);color:#f8fafc}
    .card{background:#fff;border-radius:1rem;box-shadow:0 10px 28px rgba(2,6,23,.08);padding:1.2rem}
    .dark .card{background:#1e293b}
    .btn{background:var(--brand);color:#fff;border-radius:.6rem;padding:.5rem 1rem;font-weight:700}
    .btn-ghost{border:1px dashed #94a3b8;color:#334155;border-radius:.6rem;padding:.5rem 1rem;font-weight:700;background:transparent}
    .dark .btn-ghost{color:#f1f5f9;border-color:#64748b}
    .badge{padding:.2rem .6rem;border-radius:999px;font-weight:700;font-size:.8rem}
    .b1{background:#fee2e2;color:#991b1b}.b2{background:#dbeafe;color:#1e40af}.b3{background:#d1fae5;color:#065f46}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.4rem .6rem;border-bottom:1px solid #e2e8f0;text-align:left}
    input,select{border:1px solid #e2e8f0;border-radius:.5rem;padding:.3rem .5rem;width:100%}
    .dark input,.dark select{background:#334155;border-color:#475569;color:#f8fafc}
    .num{text-align:right}
    .month-btn{padding:.4rem .8rem;border-radius:.6rem;font-weight:700;cursor:pointer}
    .month-active{background:var(--brand);color:#fff}
    #toast{position:fixed;right:20px;bottom:30px;background:var(--brand);color:#fff;padding:.5rem .9rem;border-radius:.7rem;font-weight:700;opacity:0;transform:translateY(14px);transition:.4s}
    #toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>

<body>
<header class="max-w-7xl mx-auto px-4 py-5 flex items-center justify-between">
  <h1 class="text-2xl font-extrabold flex items-center gap-2">
    🌿 ESG 簡易碳盤查 v5.4
    <span class="badge b1">S1</span><span class="badge b2">S2</span><span class="badge b3">S3</span>
  </h1>
  <button id="themeToggle" class="btn-ghost text-sm">🌞 / 🌙</button>
</header>
<div id="toast">已自動儲存！</div>

<main class="max-w-7xl mx-auto px-4 pb-28 space-y-6">

  <!-- 企業資訊 -->
  <section class="card">
    <h2 class="font-bold text-lg mb-3">🏢 企業資訊</h2>
    <div class="grid md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm mb-1">公司名稱</label>
        <input id="companyName" type="text" value="景沛 ESG" placeholder="請輸入公司名稱">
      </div>
      <div>
        <label class="block text-sm mb-1">年度（西元年）</label>
        <input id="fiscalYear" type="number" value="2025" min="2000" max="2100" step="1">
      </div>
      <div class="flex items-end gap-2">
        <button id="saveMeta" class="btn">儲存公司/年度</button>
        <span id="metaSaved" class="text-sm text-slate-500"></span>
      </div>
    </div>
  </section>

  <!-- 月份 -->
  <section class="card">
    <h2 class="font-bold text-lg mb-3">📅 月份選擇</h2>
    <div id="monthTabs" class="flex flex-wrap gap-2"></div>
  </section>

  <!-- 主表格 -->
  <section class="card">
    <div class="flex justify-between items-center mb-3">
      <h2 class="font-bold text-lg">📋 活動數據輸入</h2>
      <div class="flex gap-2">
        <button id="btnAdd" class="btn-ghost">+ 新增列</button>
        <button id="btnPreset" class="btn">載入預設 10 項</button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="table" class="text-sm">
        <thead class="bg-slate-100 dark:bg-slate-700">
          <tr>
            <th>項目</th><th>分類</th><th>範疇</th>
            <th class="num">用量</th><th>單位</th>
            <th class="num">排放係數</th><th>部門／據點</th>
            <th class="num">排放量 (kgCO₂e)</th><th>操作</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot class="bg-slate-50 dark:bg-slate-800 font-bold">
          <tr>
            <td>合計</td><td></td><td></td>
            <td id="sumAct" class="num">—</td><td></td><td></td><td></td>
            <td id="sumTotal" class="num">0</td><td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- 匯出 / 匯入 -->
    <div class="mt-4 flex flex-wrap gap-3">
      <button id="btnCalc" class="btn">重新計算</button>
      <button id="btnExportXlsxMonth" class="btn-ghost">匯出本月 Excel（.xlsx）</button>
      <button id="btnExportXlsxYear"  class="btn-ghost">匯出全年 Excel（多工作表）</button>
      <label class="btn-ghost cursor-pointer">匯入 Excel
        <input id="fileImportXlsx" type="file" class="hidden" accept=".xlsx,.xls">
      </label>
    </div>

    <!-- 建議清單（可選可自填） -->
    <datalist id="itemList"></datalist>
  </section>

  <!-- 圖表 -->
  <section class="card">
    <div class="grid md:grid-cols-3 gap-6">
      <div><h3 class="font-bold mb-2">各項目排放量（kgCO₂e）</h3><canvas id="chartItems"></canvas></div>
      <div><h3 class="font-bold mb-2">S1/S2/S3 組成比例</h3><canvas id="chartScopes"></canvas></div>
      <div><h3 class="font-bold mb-2">部門／據點彙總</h3><canvas id="chartDept"></canvas></div>
    </div>
  </section>

  <!-- PDF -->
  <section class="card">
    <div class="flex flex-wrap gap-4 items-center">
      <div class="font-semibold">📄 匯出設定：</div>
      <div class="flex items-center gap-3">
        <label class="mr-3"><input type="radio" name="scopeMode" value="month" checked> 當月</label>
        <label class="mr-3"><input type="radio" name="scopeMode" value="year"> 年度</label>
      </div>
      <label class="font-semibold">年份：</label>
      <select id="pdfYear" class="border rounded-md px-2 py-1">
        <option>2024</option><option selected>2025</option><option>2026</option>
      </select>
      <button id="exportPDF" class="btn">匯出報表 PDF</button>
    </div>
  </section>

  <!-- JS 主程式 -->
  <script>
    // ===== 全域狀態 =====
    const tbody = document.getElementById('tbody');
    const sumAct = document.getElementById('sumAct');
    const sumTotal = document.getElementById('sumTotal');
    const toast = document.getElementById('toast');
    const themeToggle = document.getElementById('themeToggle');
    const LS_THEME = 'carbonTheme';
    const META_KEY = 'carbonMeta';
    let currentMonth = new Date().getMonth() + 1;
    let viewMode = 'month'; // 'month' | 'year'

    // ===== 命名空間工具（依公司＋年度切分資料） =====
    function safeCompanyKey(name){
      return (name || '公司名稱').trim().replace(/[\\\/:*?"<>|.\s]+/g, '_');
    }
    function getCurrentMeta() {
      const metaLS = JSON.parse(localStorage.getItem(META_KEY) || '{}');
      const company = (document.getElementById('companyName')?.value || metaLS.company || '公司名稱').trim();
      const year = parseInt(document.getElementById('fiscalYear')?.value || metaLS.year || new Date().getFullYear());
      return { company, year };
    }
    function storeKeyBy(meta){
      return `carbonStore__${safeCompanyKey(meta.company)}__${meta.year}`;
    }

    // 讀取初始 store（相容舊版 key）
    const __meta0 = getCurrentMeta();
    let store = JSON.parse(
      localStorage.getItem(storeKeyBy(__meta0)) ||
      localStorage.getItem('carbonStore') ||
      '{}'
    );
    let charts = {};

    // ===== 企業資訊（公司/年度） =====
    const companyNameEl = document.getElementById('companyName');
    const fiscalYearEl  = document.getElementById('fiscalYear');
    const metaSavedEl   = document.getElementById('metaSaved');
    function loadMeta(){
      const meta = JSON.parse(localStorage.getItem(META_KEY) || '{}');
      if(meta.company) companyNameEl.value = meta.company;
      if(meta.year)    fiscalYearEl.value  = meta.year;
    }
    function saveMeta(){
      const meta = {
        company: (companyNameEl.value||'').trim() || '公司名稱',
        year: parseInt(fiscalYearEl.value) || new Date().getFullYear()
      };
      localStorage.setItem(META_KEY, JSON.stringify(meta));

      // 切換命名空間資料
      const key = storeKeyBy(meta);
      store = JSON.parse(localStorage.getItem(key) || '{}');
      if(!store[currentMonth]) store[currentMonth] = [];

      renderRows(); calc();

      metaSavedEl.textContent = '已儲存';
      setTimeout(()=>metaSavedEl.textContent='', 1500);
    }
    document.getElementById('saveMeta').onclick = saveMeta;
    loadMeta();

    // ===== 固定範疇與預設列 =====
    const SCOPE_FIX = {
      '電力':2, '水':2, '交通':3, '車用汽油':1,
      '柴油':1, '天然氣':1, '團體膳食':3, '洗潔精':3, '衛生紙':3, '廢(污)水處理':3
    };
    const PRESET = [
      {name:'電力', category:'能源', scope:2, unit:'kWh', factor:0.495, dept:'總部'},
      {name:'水', category:'資源', scope:2, unit:'m³', factor:0.156, dept:'總部'},
      {name:'交通', category:'通勤', scope:3, unit:'km', factor:0.251, dept:'業務部'},
      {name:'車用汽油', category:'燃料', scope:1, unit:'L', factor:2.92, dept:'物流'},
      {name:'柴油', category:'燃料', scope:1, unit:'L', factor:3.32, dept:'物流'},
      {name:'天然氣', category:'燃料', scope:1, unit:'m³', factor:2.63, dept:'餐飲部'},
      {name:'團體膳食', category:'餐飲', scope:3, unit:'份', factor:1.29, dept:'餐飲部'},
      {name:'洗潔精', category:'用品', scope:3, unit:'kg', factor:1.32, dept:'清潔'},
      {name:'衛生紙', category:'用品', scope:3, unit:'kg', factor:0.402, dept:'行政'},
      {name:'廢(污)水處理', category:'廢棄物', scope:3, unit:'m³', factor:0.533, dept:'清潔'}
    ];

    // 讓 datalist 自動與 PRESET 同步
    (function buildItemList(){
      const dl = document.getElementById('itemList');
      if(!dl) return;
      dl.innerHTML = PRESET.map(p=>`<option value="${p.name}"></option>`).join('');
    })();

    // ===== 月份分頁 =====
    function buildMonthTabs(){
      const wrap = document.getElementById('monthTabs');
      wrap.innerHTML = '';
      for(let m=1;m<=12;m++){
        const b = document.createElement('button');
        b.textContent = m+'月';
        b.className = 'month-btn ' + (m===currentMonth?'month-active':'');
        b.onclick = () => { save(); currentMonth = m; if(!store[m]) store[m]=[]; renderRows(); calc(); buildMonthTabs(); };
        wrap.appendChild(b);
      }
    }

    // ===== 列生成（含可選可自填） =====
    function trPresetRow(o){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${o.name}</td>
        <td>${o.category}</td>
        <td>S${o.scope}</td>
        <td><input type="number" value="${o.activity||0}" class="num activity"></td>
        <td>${o.unit}</td>
        <td>${o.factor}</td>
        <td><input type="text" value="${o.dept||'總部'}"></td>
        <td class="num emi">0</td>
        <td><button class="text-red-500 del">刪</button></td>`;
      return tr;
    }
    function trCustomRow(o){
      const s = parseInt(o.scope||3);
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>
          <input class="name-input" list="itemList" placeholder="選擇或輸入"
                 value="${o.name||''}" />
        </td>
        <td><input type="text" value="${o.category||''}"></td>
        <td>
          <select>
            <option value="1" ${s===1?'selected':''}>S1</option>
            <option value="2" ${s===2?'selected':''}>S2</option>
            <option value="3" ${s===3?'selected':''}>S3</option>
          </select>
        </td>
        <td><input type="number" value="${o.activity||0}" class="num activity"></td>
        <td><input type="text" value="${o.unit||''}"></td>
        <td><input type="number" value="${o.factor||0}" step="0.001"></td>
        <td><input type="text" value="${o.dept||'總部'}"></td>
        <td class="num emi">0</td>
        <td><button class="text-red-500 del">刪</button></td>`;
      return tr;
    }

    // ===== 新增/預設 =====
    document.getElementById('btnAdd').onclick = () => {
      const tr = trCustomRow({scope:3});
      tbody.appendChild(tr);
      tr.querySelector('.name-input')?.focus();
    };
    document.getElementById('btnPreset').onclick = () => {
      tbody.innerHTML=''; PRESET.forEach(p=>tbody.appendChild(trPresetRow({...p,activity:0}))); save(); calc();
    };

    // ===== 依選單自動帶入欄位 =====
    const PRESET_MAP = PRESET.reduce((m,p)=>{ m[p.name] = {...p}; return m; }, {});
    tbody.addEventListener('change', (e)=>{
      if(!e.target.classList.contains('name-input')) return;
      const name = (e.target.value||'').trim();
      const p = PRESET_MAP[name];
      if(!p) return; // 自創項目不帶入
      const tr = e.target.closest('tr'); if(!tr) return;
      tr.children[1].querySelector('input').value = p.category || '';
      tr.children[2].querySelector('select').value = String(p.scope||3);
      tr.children[4].querySelector('input').value = p.unit || '';
      tr.children[5].querySelector('input').value = p.factor ?? 0;
      tr.children[6].querySelector('input').value = p.dept || '總部';
      calc();
    });

    // ===== 儲存/載入 =====
    function gatherRows(){
      return [...tbody.querySelectorAll('tr')].map(tr=>{
        const t=tr.children;
        const name=t[0].querySelector('input')?t[0].querySelector('input').value:t[0].textContent;
        const category=t[1].querySelector('input')?t[1].querySelector('input').value:t[1].textContent;
        const scopeStr=t[2].querySelector('select')?t[2].querySelector('select').value:t[2].textContent.replace('S','');
        const scope=parseInt(scopeStr)||3;
        const activity=parseFloat(t[3].querySelector('input').value)||0;
        const unit=t[4].querySelector('input')?t[4].querySelector('input').value:t[4].textContent;
        const factor=parseFloat(t[5].querySelector('input')?t[5].querySelector('input').value:t[5].textContent)||0;
        const dept=t[6].querySelector('input').value||'';
        return {name,category,scope,activity,unit,factor,dept};
      });
    }
    function save(){
      const meta = getCurrentMeta();
      const key  = storeKeyBy(meta);
      store[currentMonth] = gatherRows();
      localStorage.setItem(key, JSON.stringify(store));
      toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1200);
    }
    function renderRows(){
      tbody.innerHTML='';
      (store[currentMonth]||[]).forEach(r=>{
        if(SCOPE_FIX[r.name]) tbody.appendChild(trPresetRow(r));
        else tbody.appendChild(trCustomRow(r));
      });
    }

    // ===== 視圖資料（當月 / 年度）與統計 =====
    function rowsForMode(){
      if(viewMode==='month') return (store[currentMonth]||[]);
      return Array.from({length:12},(_,i)=>store[i+1]||[]).flat();
    }
    function totalFor(rows){
      return rows.reduce((s,r)=> s + (parseFloat(r.activity)||0)*(parseFloat(r.factor)||0), 0);
    }

    // ===== 計算與圖表 =====
    function calc(){
      let total=0, actSum=0;
      [...tbody.querySelectorAll('tr')].forEach(tr=>{
        const act=parseFloat(tr.querySelector('.activity')?.value)||0;
        const factor=parseFloat(tr.children[5].textContent || tr.children[5].querySelector('input')?.value)||0;
        const emi=act*factor;
        tr.querySelector('.emi').textContent = emi.toFixed(3);
        total+=emi; actSum+=act;
      });
      sumTotal.textContent = total.toFixed(3);
      sumAct.textContent   = actSum.toFixed(2);
      save(); updateCharts();
    }
    document.getElementById('btnCalc').onclick = calc;
    tbody.addEventListener('input', calc);
    tbody.addEventListener('click', e=>{ if(e.target.classList.contains('del')){ e.target.closest('tr').remove(); calc(); } });

    // 當月 / 年度切換
    document.querySelectorAll('input[name="scopeMode"]').forEach(r=>{
      r.onchange = () => { viewMode = r.value; updateCharts(); };
    });

    function updateCharts(){
      const rows=rowsForMode();
      const labels=rows.map(r=>r.name);
      const emis=rows.map(r=>(r.activity||0)*(r.factor||0));
      const byScope={S1:0,S2:0,S3:0}, byDept={};
      rows.forEach(r=>{
        const s='S'+(r.scope||3);
        const emi=(r.activity||0)*(r.factor||0);
        byScope[s]+=emi;
        const d=(r.dept||'未填'); byDept[d]=(byDept[d]||0)+emi;
      });

      charts.items?.destroy(); charts.scopes?.destroy(); charts.dept?.destroy();
      charts.items=new Chart(document.getElementById('chartItems'),{
        type:'bar', data:{labels,datasets:[{label:'排放量',data:emis}]},
        options:{responsive:true,plugins:{legend:{display:false}}}
      });
      charts.scopes=new Chart(document.getElementById('chartScopes'),{
        type:'pie', data:{labels:Object.keys(byScope),datasets:[{data:Object.values(byScope)}]}
      });
      charts.dept=new Chart(document.getElementById('chartDept'),{
        type:'bar', data:{labels:Object.keys(byDept),datasets:[{label:'部門',data:Object.values(byDept)}]},
        options:{indexAxis:'y',plugins:{legend:{display:false}}}
      });
    }

    // ===== Excel（.xlsx） =====
    function rowsToSheet(rows, meta){
      const company=(meta?.company || companyNameEl.value || '公司名稱').trim();
      const year=meta?.year || parseInt(fiscalYearEl.value) || new Date().getFullYear();
      const header=['項目','分類','範疇(S1/S2/S3)','用量','單位','排放係數','部門','排放量(kgCO2e)'];
      const data=[['公司名稱',company],['年度',String(year)],[],header];
      rows.forEach(r=>{
        data.push([r.name,r.category,'S'+(r.scope||3),r.activity||0,r.unit||'',r.factor||0,r.dept||'',((r.activity||0)*(r.factor||0)).toFixed(3)]);
      });
      const ws=XLSX.utils.aoa_to_sheet(data);
      ws['!cols']=[{wch:16},{wch:22},{wch:14},{wch:12},{wch:10},{wch:16},{wch:16},{wch:18}];
      ws['!freeze']={xSplit:0,ySplit:4};
      return ws;
    }
    function getMonthRows(m){ return (store[m]||[]); }

    document.getElementById('btnExportXlsxMonth').onclick=()=>{
      calc();
      const meta=JSON.parse(localStorage.getItem(META_KEY)||'{}');
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, rowsToSheet(getMonthRows(currentMonth),meta), `${currentMonth}月`);
      const company=(meta.company||companyNameEl.value||'公司').replace(/[\\\/:*?"<>|]/g,'_');
      const year=meta.year||parseInt(fiscalYearEl.value)||new Date().getFullYear();
      XLSX.writeFile(wb, `${company}_碳盤查_${year}_${currentMonth}月.xlsx`);
    };

    document.getElementById('btnExportXlsxYear').onclick=()=>{
      calc();
      const meta=JSON.parse(localStorage.getItem(META_KEY)||'{}');
      const wb=XLSX.utils.book_new();
      for(let m=1;m<=12;m++){
        XLSX.utils.book_append_sheet(wb, rowsToSheet(getMonthRows(m),meta), `${m}月`);
      }
      const company=(meta.company||companyNameEl.value||'公司名稱').replace(/[\\\/:*?"<>|]/g,'_');
      const year=meta.year||parseInt(fiscalYearEl.value)||new Date().getFullYear();

      // 年度彙總
      const byScope={S1:0,S2:0,S3:0}, byDept={};
      for(let m=1;m<=12;m++){
        (store[m]||[]).forEach(r=>{
          const s='S'+(parseInt(r.scope)||3);
          const emi=(parseFloat(r.activity)||0)*(parseFloat(r.factor)||0);
          byScope[s]+=emi; const d=r.dept||'總部'; byDept[d]=(byDept[d]||0)+emi;
        });
      }
      const summary=[['公司名稱', (meta.company||companyNameEl.value||'公司名稱')], ['年度', String(year)], [], ['年度彙總','kgCO2e'],
                     ['S1',byScope.S1],['S2',byScope.S2],['S3',byScope.S3],[],['部門','kgCO2e']];
      Object.keys(byDept).forEach(k=>summary.push([k,byDept[k]]));
      const wsSum=XLSX.utils.aoa_to_sheet(summary); wsSum['!cols']=[{wch:16},{wch:22}];
      XLSX.utils.book_append_sheet(wb, wsSum, '年度彙總');

      XLSX.writeFile(wb, `${company}_碳盤查_${year}_全年.xlsx`);
    };

    // 匯入 Excel（覆蓋目前月份）
    document.getElementById('fileImportXlsx').onchange=(e)=>{
      const f=e.target.files[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=(evt)=>{
        const wb=XLSX.read(new Uint8Array(evt.target.result),{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const arr=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
        if(arr.length<=1){alert('檔案沒有資料');return;}
        // 找到標頭列（跳過公司/年度）
        let startIdx=0; for(let i=0;i<arr.length;i++){ if(String(arr[i][0]).includes('項目')){ startIdx=i; break; } }
        const rowsData=arr.slice(startIdx+1);
        tbody.innerHTML='';
        rowsData.forEach(row=>{
          if(row.every(v=>String(v).trim()==='')) return;
          const scope=parseInt(String(row[2]).replace(/[^\d]/g,''))||3;
          const obj={name:row[0],category:row[1],scope,activity:parseFloat(row[3])||0,unit:row[4],factor:parseFloat(row[5])||0,dept:row[6]||'總部'};
          if(SCOPE_FIX[obj.name]) tbody.appendChild(trPresetRow(obj)); else tbody.appendChild(trCustomRow(obj));
        });
        save(); calc(); e.target.value='';
      };
      reader.readAsArrayBuffer(f);
    };

    // ===== PDF 匯出（file:// 也可用） =====
    function makeTextImage(lines, width=800, height=60){
      const canvas = document.createElement('canvas');
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,width,height);
      ctx.fillStyle = '#0f5132';
      ctx.font = 'bold 18px "Microsoft JhengHei", system-ui, Arial';
      ctx.fillText(lines[0] || '', 12, 24);
      ctx.fillStyle = '#111827';
      ctx.font = '14px "Microsoft JhengHei", system-ui, Arial';
      if(lines[1]) ctx.fillText(lines[1], 12, 46);
      return canvas.toDataURL('image/png',1.0);
    }

    document.getElementById('exportPDF').onclick = async ()=>{
      try{
        if (typeof calc === 'function') calc();

        // 暫關動畫，避免截圖不一致
        const oldAnim = Chart.defaults.animation;
        Chart.defaults.animation = false;
        if (typeof updateCharts === 'function') updateCharts();

        const rafWait = (n=4)=>new Promise(r=>{
          const step = k => k<=0 ? r() : requestAnimationFrame(()=>step(k-1));
          step(n);
        });
        await rafWait(4);

        if(!window.PDFLib) throw new Error('pdf-lib 未載入');
        const {PDFDocument} = PDFLib;

        const meta=JSON.parse(localStorage.getItem(META_KEY)||'{}');
        const company=(meta.company||companyNameEl.value||'公司名稱').trim();
        const year=meta.year||parseInt(fiscalYearEl.value)||new Date().getFullYear();
        const month=(typeof currentMonth==='number')?currentMonth:(new Date().getMonth()+1);

        const rows = rowsForMode();
        const total = totalFor(rows).toFixed(3);
        const periodText = (viewMode==='month') ? `${year} 年 ${month} 月` : `${year} 年（年度）`;

        const titleImg = makeTextImage(
          [`${company} 碳盤查報表｜${periodText}`, `總排放量：${total} kgCO₂e`],
          800, 60
        );

        const c1=document.getElementById('chartItems');
        const c2=document.getElementById('chartScopes');
        const c3=document.getElementById('chartDept');
        const img1=c1?.toDataURL('image/png',1.0);
        const img2=c2?.toDataURL('image/png',1.0);
        const img3=c3?.toDataURL('image/png',1.0);

        const pdf=await PDFDocument.create();
        const page=pdf.addPage([842,595]); // A4 橫
        const pTitle=await pdf.embedPng(titleImg);
        page.drawImage(pTitle,{x:21,y:520,width:800,height:60});
        if(img1){ const p1=await pdf.embedPng(img1); page.drawImage(p1,{x:40,y:310,width:360,height:200}); }
        if(img2){ const p2=await pdf.embedPng(img2); page.drawImage(p2,{x:430,y:310,width:360,height:200}); }
        if(img3){ const p3=await pdf.embedPng(img3); page.drawImage(p3,{x:40,y: 80,width:750,height:200}); }

        const bytes=await pdf.save();
        const a=document.createElement('a');
        a.href=URL.createObjectURL(new Blob([bytes],{type:'application/pdf'}));
        const safeCompany=company.replace(/[\\\/:*?"<>|]/g,'_');
        const fileSuffix=(viewMode==='month')?`M${month}`:'Y';
        a.download=`${safeCompany}_ESG_Report_${year}_${fileSuffix}.pdf`;
        a.click();

        Chart.defaults.animation = oldAnim; // 還原
      }catch(err){ alert('PDF 匯出失敗：'+err.message); }
    };

    // ===== 主題 & 初始化 =====
    function applyTheme(t){ document.documentElement.classList.toggle('dark', t==='dark'); localStorage.setItem(LS_THEME,t); }
    themeToggle.onclick = ()=>{ const isDark=document.documentElement.classList.contains('dark'); applyTheme(isDark?'light':'dark'); };
    applyTheme(localStorage.getItem(LS_THEME)||'light');

    function init(){
      buildMonthTabs();
      if(!store[currentMonth]) store[currentMonth]=[];
      if(store[currentMonth].length===0){ tbody.innerHTML=''; PRESET.forEach(p=>tbody.appendChild(trPresetRow({...p,activity:0}))); save(); }
      renderRows(); calc();
      if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js').catch(()=>{}); }
    }
    init();
  </script>
</main>
</body>
</html>
